<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>War Universe Fight Simulator</title>
    <style>

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Arial', sans-serif;
            background-image: url('images/bg.avif');
            background-size: cover;
            background-position: center;
            background-attachment: fixed;
            min-height: 100vh;
            color: #fff;
            position: relative;
        }



        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 3px;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
            background: rgba(50, 50, 50, 0.9);
            padding: 20px;
            border-radius: 10px;
            border: 2px solid #444;
        }

        .header h1 {
            font-size: 2.5em;
            color: #00ff00;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.8);
            margin-bottom: 10px;
        }

        .ship-panel-header {
            text-align: center;
            margin-bottom: 20px;
            padding: 10px;
            background: rgba(0, 102, 204, 0.3);
            border-radius: 5px;
            border: 1px solid #0099ff;
        }

        .ship-panel-header h2 {
            color: #00ff00;
            font-size: 1.5em;
            margin: 0;
        }

        .main-content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        @media (max-width: 768px) {
            .main-content {
                grid-template-columns: 1fr;
            }
        }

        .ship-panel {
            background: rgba(40, 40, 40, 0.9);
            border: 2px solid #444;
            border-radius: 10px;
            padding: 8px;
            transition: opacity 0.3s ease;
        }


        .ship-selection {
            margin-bottom: 20px;
            padding: 5px;
        }

        .ship-dropdown {
            width: 100%;
            padding: 10px;
            background: #333;
            color: #fff;
            border: 2px solid #555;
            border-radius: 5px;
            font-size: 16px;
            cursor: pointer;
        }

        .ship-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            max-height: 200px;
            overflow-y: auto;
            margin-top: 10px;
            padding: 10px;
            background: rgba(30, 30, 30, 0.8);
            border-radius: 5px;
        }

        .ship-item {
            display: flex;
            align-items: center;
            padding: 10px;
            background: #333;
            border: 1px solid #555;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .ship-item:hover {
            background: #444;
            border-color: #777;
        }

        .ship-item.selected {
            background: #0066cc;
            border-color: #0099ff;
        }

        .ship-icon {
            width: 60px;
            height: 44px;
            margin-right: 10px;
            object-fit: contain;
        }

        .ship-info {
            flex: 1;
        }

        .ship-name {
            font-weight: bold;
            margin-bottom: 5px;
        }

        .ship-stats {
            font-size: 12px;
            color: #ccc;
        }

        .hangar {
            margin-bottom: 20px;
        }

        .hangar-title {
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 10px;
            color: #00ff00;
        }

        .equipment-slots {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 2px;
            margin-bottom: 15px;
        }

        .slot {
            width: 60px;
            height: 60px;
            background: #222;
            border: 2px solid #444;
            border-radius: 5px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
        }

        .slot:hover {
            border-color: #666;
            background: #333;
        }

        .slot.occupied {
            border-color: #005b00;
        }

        .slot-label {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 14px;
            color: #fff;
            font-weight: bold;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.8);
            pointer-events: none;
            z-index: 1;
        }

        .slot.occupied .slot-label {
            display: none;
        }

        .equipment-icon {
            width: 50px;
            height: 50px;
            object-fit: contain;
        }

        .drone-section {
            margin-bottom: 15px;
        }

        .drone-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
        }

        .drone-block {
            display: flex;
            align-items: center;
            background: #333;
            border: 1px solid #555;
            border-radius: 5px;
            padding: 5px;
        }

        .drone-icon {
            width: 40px;
            height: 40px;
            object-fit: contain;
        }

        .drone-slots {
            display: flex;
            gap: 5px;
        }

        .drone-slot {
            width: 35px;
            height: 35px;
            background: #222;
            border: 1px solid #444;
            border-radius: 3px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .equipment-selection {
            margin-bottom: 20px;
        }

        .equipment-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 10px;
            margin-bottom: 15px;
        }

        .equipment-item {
            width: 60px;
            height: 60px;
            background: #333;
            border: 2px solid #555;
            border-radius: 5px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }

        .equipment-item:hover {
            background: #444;
            border-color: #777;
        }

        .resource-section {
            margin-bottom: 20px;
        }

        .resource-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
        }

        .resource-item {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .resource-label {
            font-weight: bold;
            color: #00ff00;
        }

        .resource-select {
            padding: 8px;
            background: #333;
            color: #fff;
            border: 2px solid #555;
            border-radius: 5px;
            cursor: pointer;
        }

        .battle-controls {
            text-align: center;
        }

        .battle-btn {
            padding: 15px 30px;
            background: #ff6600;
            color: #fff;
            border: none;
            border-radius: 5px;
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            margin: 0 10px;
        }

        .battle-btn:hover {
            background: #ff8833;
            box-shadow: 0 0 15px rgba(255, 102, 0, 0.5);
        }

        .speed-control {
            display: inline-flex;
            align-items: center;
            gap: 10px;
            margin: 15px 0;
            padding: 10px 20px;
            background: rgba(40, 40, 40, 0.9);
            border: 2px solid #444;
            border-radius: 5px;
        }

        .speed-control label {
            color: #00ff00;
            font-weight: bold;
        }

        #battle-speed {
            width: 200px;
            height: 8px;
            background: #333;
            outline: none;
            border-radius: 4px;
            cursor: pointer;
        }

        #battle-speed::-webkit-slider-thumb {
            appearance: none;
            width: 20px;
            height: 20px;
            background: #ff6600;
            border-radius: 50%;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        #battle-speed::-webkit-slider-thumb:hover {
            background: #ff8833;
            box-shadow: 0 0 10px rgba(255, 102, 0, 0.5);
        }

        #battle-speed::-moz-range-thumb {
            width: 20px;
            height: 20px;
            background: #ff6600;
            border-radius: 50%;
            cursor: pointer;
            border: none;
            transition: all 0.3s ease;
        }

        #battle-speed::-moz-range-thumb:hover {
            background: #ff8833;
            box-shadow: 0 0 10px rgba(255, 102, 0, 0.5);
        }

        #speed-display {
            color: #fff;
            font-weight: bold;
            min-width: 40px;
            text-align: left;
        }


        .stats-panel {
            background: rgba(30, 30, 30, 0.9);
            border: 2px solid #444;
            border-radius: 10px;
            margin-bottom: 20px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin: 10px;
        }

        .stat-item {
            background: #333;
            padding: 10px;
            border-radius: 5px;
            border: 1px solid #555;
        }

        .stat-label {
            font-weight: bold;
            color: #00ff00;
            margin-bottom: 5px;
        }

        .stat-value {
            font-size: 18px;
            color: #fff;
            white-space: nowrap;
        }

        .battle-log {
            background: rgba(20, 20, 20, 0.9);
            border: 2px solid #444;
            border-radius: 10px;
            padding: 20px;
            max-height: 300px;
            overflow-y: auto;
            min-height: 300px;
        }

        .battle-log.empty {
            display: flex;
            align-items: center;
            justify-content: center;
            color: #666;
            font-style: italic;
        }

        .battle-log.empty::before {
            content: "Battle log will appear here when fight starts...";
        }

        .log-entry {
            padding: 5px;
            margin-bottom: 5px;
            border-left: 3px solid #00ff00;
            padding-left: 10px;
        }

        .battle-logs-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        @media (max-width: 768px) {
            .battle-logs-container {
                grid-template-columns: 1fr;
            }
        }

        .ship-battle-log {
            border-radius: 10px;
            padding: 15px;
            max-height: 300px;
            overflow-y: auto;
            min-height: 300px;
            border: 2px solid #444;
            font-size: small;
        }

        .ship-battle-log.ship1-log {
            background: rgba(0, 40, 0, 0.9);
        }

        .ship-battle-log.ship2-log {
            background: rgba(40, 0, 0, 0.9);
        }

        .ship-battle-log.empty {
            
            color: #666;
            font-style: italic;
            font-size: 18px;
            font-weight: bold;
            padding-bottom: 10px;
            border-bottom: 2px solid #555;
            position: relative;
        }

        .ship-battle-log.empty::before {
            content: "Battle log will appear here when fight starts...";
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 100%;
            text-align: center;
        }

        .ship-log-header {
            text-align: center;
            font-size: 18px;
            font-weight: bold;
            padding-bottom: 10px;
            border-bottom: 2px solid #555;
        }

        .ship1-log .ship-log-header {
            color: #00ff00;
        }

        .ship2-log .ship-log-header {
            color: #ff6666;
        }

        .ship-log-entry {
            padding: 2px;
            margin-bottom: 5px;
            border-left: 3px solid #00ff00;
            padding-left: 10px;
        }

        .ship1-log .ship-log-entry {
            border-left-color: #00ff00;
        }

        .ship2-log .ship-log-entry {
            border-left-color: #ff6666;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        .modal-content {
            background: #333;
            border: 2px solid #555;
            border-radius: 10px;
            padding: 20px;
            max-width: 400px;
            width: 90%;
            position: relative;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .modal-title {
            font-size: 18px;
            font-weight: bold;
            color: #00ff00;
        }

        .close-btn {
            background: #ff0000;
            color: #fff;
            border: none;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            cursor: pointer;
            font-size: 18px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-options {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .modal-option {
            padding: 10px;
            background: #444;
            border: 1px solid #666;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .modal-option:hover {
            background: #555;
            border-color: #888;
        }

        .modal-options.icon-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            max-height: 300px;
            overflow-y: auto;
        }

        .modal-option.icon-option {
            padding: 3px;
            background: #444;
            border: 1px solid #666;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        .modal-option.icon-option:hover {
            background: #555;
            border-color: #888;
        }

        .modal-option.icon-option img {
            width: 40px;
            height: 40px;
            object-fit: contain;
            margin-bottom: 5px;
        }

        .modal-option.icon-option .icon-label {
            font-size: 12px;
            color: #fff;
            text-align: center;
            font-weight: bold;
        }

        .save-load-section {
            text-align: center;
            margin-bottom: 20px;
        }

        .save-load-btn {
            padding: 10px 20px;
            background: #0066cc;
            color: #fff;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            margin: 0 5px;
            transition: all 0.3s ease;
        }

        .save-load-btn:hover {
            background: #0088ff;
        }

        .save-load-input {
            padding: 10px;
            background: #333;
            color: #fff;
            border: 2px solid #555;
            border-radius: 5px;
            width: 300px;
            margin: 0 10px;
        }

        .premium-rocket-section {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            gap: 20px;
        }

        .premium-toggle {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .rocket-selection {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .rocket-select {
            padding: 8px;
            background: #333;
            color: #fff;
            border: 2px solid #555;
            border-radius: 5px;
            cursor: pointer;
        }

        .toggle-switch {
            position: relative;
            width: 60px;
            height: 30px;
            background: #333;
            border-radius: 15px;
            cursor: pointer;
            transition: background 0.3s ease;
        }

        .toggle-switch.active {
            background: #00ff00;
        }

        .toggle-slider {
            position: absolute;
            top: 3px;
            left: 3px;
            width: 24px;
            height: 24px;
            background: #fff;
            border-radius: 50%;
            transition: transform 0.3s ease;
        }

        .toggle-switch.active .toggle-slider {
            transform: translateX(30px);
        }

        .battle-mode-selector {
            margin-bottom: 15px;
        }

        .mode-buttons {
            display: flex;
            gap: 10px;
            justify-content: center;
        }

        .mode-btn {
            padding: 8px 16px;
            background: #333;
            color: #fff;
            border: 2px solid #555;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .mode-btn.active {
            background: #ff6600;
            border-color: #ff8833;
        }

        .hp-bar {
            width: 100%;
            height: 20px;
            background: #333;
            border: 2px solid #555;
            border-radius: 10px;
            overflow: hidden;
            margin: 5px 0;
        }

        .hp-fill {
            height: 100%;
            background: linear-gradient(90deg, #ff0000, #ff6600);
            transition: width 0.3s ease;
        }

        .shield-bar {
            width: 100%;
            height: 20px;
            background: #333;
            border: 2px solid #555;
            border-radius: 10px;
            overflow: hidden;
            margin: 5px 0;
        }

        .shield-fill {
            height: 100%;
            background: linear-gradient(90deg, #0066cc, #0099ff);
            transition: width 0.3s ease;
        }

        .ship-status-box {
            background: rgba(30, 30, 30, 0.9);
            border: 2px solid #444;
            border-radius: 10px;
            padding: 10px;
            margin: 5px;
        }

        .ship-name-header {
            text-align: center;
            font-size: 18px;
            font-weight: bold;
            color: #00ff00;
            margin-bottom: 8px;
            border-bottom: 1px solid #555;
            padding-bottom: 5px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .time-box {
            background: rgba(30, 30, 30, 0.9);
            border: 2px solid #444;
            border-radius: 10px;
            padding: 15px;
            margin: 5px;
            text-align: center;
            min-width: 120px;
            align-self: center;
            flex-shrink: 0;
        }

        .battle-stats {
            min-height: 200px;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            flex-wrap: wrap;
            display: grid;
            grid-template-columns: repeat(2, 1fr);
        }

        .hp-shield-combo {
            margin: 0;
        }

        .hp-shield-combo .stat-value {
            margin-bottom: 8px;
            font-size: 16px;
            color: #fff;
            text-align: center;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            font-family: 'Courier New', monospace;
            font-weight: bold;
        }

        .hp-shield-combo .hp-bar {
            margin-bottom: 12px;
        }

        .hp-shield-combo .shield-bar {
            margin-top: 0;
        }

        .battle-stats.empty {
            opacity: 0.7;
        }

        .battle-history-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            width: 100%;
        }

        .battle-history-dropdown {
            background: rgba(30, 30, 30, 0.9);
            border: 2px solid #444;
            border-radius: 10px;
            padding: 10px;
            margin: 5px;
            position: relative;
            transition: all 0.3s ease;
        }

        .battle-history-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
        }

        .battle-history-title {
            font-size: 16px;
            font-weight: bold;
            color: #00ff00;
        }

        .dropdown-arrow {
            width: 0;
            height: 0;
            border-left: 8px solid transparent;
            border-right: 8px solid transparent;
            border-top: 12px solid #00ff00;
            transition: transform 0.3s ease;
        }

        .dropdown-arrow.expanded {
            transform: rotate(180deg);
        }

        .battle-history-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease;
        }

        .battle-history-content.expanded {
            max-height: 200px;
            overflow-y: auto;
            min-height: 200px;
        }

        .history-entry {
            padding: 5px 0;
            border-bottom: 1px solid #333;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            color: #fff;
            line-height: 1.4;
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            align-items: center;
        }

        .history-entry:last-child {
            border-bottom: none;
        }

        .history-tick {
            color: #00ff00;
            font-weight: bold;
            white-space: nowrap;
        }

        .history-hp-change {
            color: #ff6666;
            white-space: nowrap;
        }

        .history-shield-change {
            color: #0099ff;
            white-space: nowrap;
        }

        .history-sab-restore {
            color: #ffaa00;
            white-space: nowrap;
        }

        .history-total {
            font-weight: bold;
            color: #fff;
            white-space: nowrap;
        }

        .battle-history-content::-webkit-scrollbar {
            width: 8px;
        }

        .battle-history-content::-webkit-scrollbar-track {
            background: #222;
            border-radius: 4px;
        }

        .battle-history-content::-webkit-scrollbar-thumb {
            background: #555;
            border-radius: 4px;
        }

        .battle-history-content::-webkit-scrollbar-thumb:hover {
            background: #777;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>War Universe Fight Simulator</h1>
        </div>

        <div class="main-content">
            <div class="ship-panel" id="ship-panel-1">
                <div class="ship-panel-header">
                    <h2>Ship 1</h2>
                </div>
                <div class="ship-selection">
                    <div class="ship-grid" id="ship-grid-1"></div>
                </div>

                <div class="hangar">
                    <div class="hangar-title">Hangar</div>
                    <div class="equipment-slots" id="ship-slots-1"></div>
                    <div class="drone-section">
                        <div class="drone-grid" id="drone-grid-1"></div>
                    </div>
                </div>

                <div class="equipment-selection">
                    <div class="equipment-grid" id="equipment-grid-1"></div>
                    <div class="equipment-grid" id="drone-covers-1"></div>
                </div>

                <div class="resource-section">
                    <div class="hangar-title">Upgraded Resources</div>
                    <div class="resource-grid" id="resource-grid-1"></div>
                </div>

                <div class="premium-rocket-section">
                    <div class="premium-toggle">
                        <span>Premium:</span>
                        <div class="toggle-switch" id="premium-1">
                            <div class="toggle-slider"></div>
                        </div>
                        <span class="tooltip" title="Premium: 2x faster Rocket launch">ℹ️</span>
                    </div>
                    <div class="rocket-selection">
                        <label for="rocket-select-1">Rocket:</label>
                        <select id="rocket-select-1" class="rocket-select">
                            <option value="none">None</option>
                            <option value="kep-410">KEP-410 (1000)</option>
                            <option value="nc-30">NC-30 (2000)</option>
                            <option value="tnc-130">TNC-130 (4000)</option>
                        </select>
                    </div>
                </div>

                <div class="battle-mode-selector">
                    <div class="mode-buttons">
                        <button class="mode-btn active" data-mode="x4">Plain X4</button>
                        <button class="mode-btn" data-mode="x4x6">X4/X6</button>
                        <button class="mode-btn" data-mode="sabx6">SAB/X6</button>
                    </div>
                </div>

                <div class="stats-panel">
                    <div class="stats-grid" id="stats-grid-1"></div>
                </div>
            </div>

            <div class="ship-panel" id="ship-panel-2">
                <div class="ship-panel-header">
                    <h2>Ship 2</h2>
                </div>
                <div class="ship-selection">
                    <div class="ship-grid" id="ship-grid-2"></div>
                </div>

                <div class="hangar">
                    <div class="hangar-title">Hangar</div>
                    <div class="equipment-slots" id="ship-slots-2"></div>
                    <div class="drone-section">
                        <div class="drone-grid" id="drone-grid-2"></div>
                    </div>
                </div>

                <div class="equipment-selection">
                    <div class="equipment-grid" id="equipment-grid-2"></div>
                    <div class="equipment-grid" id="drone-covers-2"></div>
                </div>

                <div class="resource-section">
                    <div class="hangar-title">Upgraded Resources</div>
                    <div class="resource-grid" id="resource-grid-2"></div>
                </div>

                <div class="premium-rocket-section">
                    <div class="premium-toggle">
                        <span>Premium:</span>
                        <div class="toggle-switch" id="premium-2">
                            <div class="toggle-slider"></div>
                        </div>
                        <span class="tooltip" title="Premium: 2x faster Rocket launch">ℹ️</span>
                    </div>
                    <div class="rocket-selection">
                        <label for="rocket-select-2">Rocket:</label>
                        <select id="rocket-select-2" class="rocket-select">
                            <option value="none">None</option>
                            <option value="kep-410">KEP-410 (1000)</option>
                            <option value="nc-30">NC-30 (2000)</option>
                            <option value="tnc-130">TNC-130 (4000)</option>
                        </select>
                    </div>
                </div>

                <div class="battle-mode-selector">
                    <div class="mode-buttons">
                        <button class="mode-btn active" data-mode="x4">Plain X4</button>
                        <button class="mode-btn" data-mode="x4x6">X4/X6</button>
                        <button class="mode-btn" data-mode="sabx6">SAB/X6</button>
                    </div>
                </div>

                <div class="stats-panel">
                    <div class="stats-grid" id="stats-grid-2"></div>
                </div>
            </div>
        </div>

        <div class="save-load-section">
            <input type="text" class="save-load-input" id="save-input" placeholder="Paste saved configuration">
            <button class="save-load-btn" onclick="saveConfiguration()">Save Configuration</button>
            <button class="save-load-btn" onclick="loadConfiguration()">Load Configuration</button>
        </div>

        <div class="battle-controls">
            <button class="battle-btn" onclick="startBattle()">START BATTLE</button>
            <button class="battle-btn" onclick="resetBattle()">RESET</button>
            <div class="speed-control">
                <label for="battle-speed">Battle Speed:</label>
                <input type="range" id="battle-speed" min="100" max="10000" value="1000" step="100">
                <span id="speed-display">1.0s</span>
            </div>
        </div>


        <div class="stats-panel">
            <div class="battle-stats" id="battle-stats"></div>
            <div class="battle-history-container" id="battle-history-container" style="display: none;">
                <div class="battle-history-dropdown">
                    <div class="battle-history-header" onclick="toggleBattleHistory(1)">
                        <div class="battle-history-title">Ship 1 History</div>
                        <div class="dropdown-arrow" id="arrow-1"></div>
                    </div>
                    <div class="battle-history-content" id="history-content-1"></div>
                </div>
                <div class="battle-history-dropdown">
                    <div class="battle-history-header" onclick="toggleBattleHistory(2)">
                        <div class="battle-history-title">Ship 2 History</div>
                        <div class="dropdown-arrow" id="arrow-2"></div>
                    </div>
                    <div class="battle-history-content" id="history-content-2"></div>
                </div>
            </div>
        </div>

        <div class="battle-logs-container">
            <div class="ship-battle-log ship1-log empty" id="ship1-battle-log">
                <div class="ship-log-header">Ship 1</div>
            </div>
            <div class="ship-battle-log ship2-log empty" id="ship2-battle-log">
                <div class="ship-log-header">Ship 2</div>
            </div>
        </div>
    </div>

    <div class="modal" id="equipment-modal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title" id="modal-title">Select Equipment</div>
                <button class="close-btn" onclick="closeModal()">×</button>
            </div>
            <div class="modal-options" id="modal-options"></div>
        </div>
    </div>

    <script>
        const SHIPS_DATA = {
            'ship10': { name: 'Shuttle', hp: 8000, speed: 330, lasers: 1, generators: 1, image: 'images/ships/ship10.png' },
            'ship20': { name: 'Zephyrus', hp: 76000, speed: 380, lasers: 4, generators: 3, image: 'images/ships/ship20.png' },
            'ship30': { name: 'Thorus', hp: 92000, speed: 320, lasers: 6, generators: 4, image: 'images/ships/ship30.png' },
            'ship41': { name: 'Veles-X', hp: 130000, speed: 360, lasers: 14, generators: 8, image: 'images/ships/ship41.png' },
            'ship40': { name: 'Veles', hp: 64000, speed: 340, lasers: 8, generators: 6, image: 'images/ships/ship40.png' },
            'ship50': { name: 'Calipso', hp: 126000, speed: 370, lasers: 10, generators: 12, image: 'images/ships/ship50.png' },
            'ship60': { name: 'Hecate', hp: 512000, speed: 300, lasers: 12, generators: 12, image: 'images/ships/ship60.png' },
            'ship70': { name: 'Svarog', hp: 196000, speed: 340, lasers: 14, generators: 10, image: 'images/ships/ship70.png' },
            'ship80': { name: 'Caviar', hp: 176000, speed: 390, lasers: 14, generators: 10, image: 'images/ships/ship80.png' },
            'ship90': { name: 'Hyperion', hp: 296000, speed: 300, lasers: 16, generators: 16, image: 'images/ships/ship90.png' },
            'ship100': { name: 'Perun', hp: 272000, speed: 330, lasers: 20, generators: 12, image: 'images/ships/ship100.png' },
            'ship101': { name: 'Stinger', hp: 76000, speed: 440, lasers: 24, generators: 4, image: 'images/ships/ship101.png' },
            'ship102': { name: 'Heavy Falcon', hp: 768000, speed: 180, lasers: 14, generators: 24, image: 'images/ships/ship102.png' },
            'ship108': { name: 'Vostok-M', hp: 296000, speed: 340, lasers: 18, generators: 12, image: 'images/ships/ship108.png' }
        };

        const LASER_GUNS = {
            'laser-gun-1': { name: 'LaserGun-1', damage: 60, shortName: 'LG1', image: 'images/equip/igun1.png' },
            'laser-gun-2': { name: 'LaserGun-2', damage: 100, shortName: 'LG2', image: 'images/equip/igun2.png' },
            'laser-gun-3': { name: 'LaserGun-3', damage: 150, shortName: 'LG3', image: 'images/equip/igun3.png' },
            'laser-gun-4': { name: 'LaserGun-4', damage: 175, shortName: 'LG4', image: 'images/equip/igun7.png' }
        };

        const SHIELD_GENERATORS = {
            'shield-gen-1': { name: 'ShieldGen-1', hp: 5000, absorption: 60, shortName: 'SG1', image: 'images/equip/ish1.png' },
            'shield-gen-2': { name: 'ShieldGen-2', hp: 10000, absorption: 70, shortName: 'SG2', image: 'images/equip/ish2.png' },
            'shield-gen-3': { name: 'ShieldGen-3', hp: 16000, absorption: 85, shortName: 'SG3', image: 'images/equip/ish3.png' }
        };

        const ACCELERATORS = {
            'accelerator-3': { name: 'Accelerator-3', speed: 10, shortName: 'ACC3', image: 'images/equip/isp3.png' }
        };

        const ROCKETS = {
            'kep-410': { name: 'KEP-410', damage: 1000, image: 'images/missiles/rocket1.png' },
            'nc-30': { name: 'NC-30', damage: 2000, image: 'images/missiles/rocket2.png' },
            'tnc-130': { name: 'TNC-130', damage: 4000, image: 'images/missiles/rocket3.png' }
        };

        const DRONE_COVERS = {
            'dcd': { name: 'DCD', description: '+5% laser damage', max: 5, image: 'images/equip/drcover1.png' },
            'dcs': { name: 'DCS', description: '+10% shield HP', max: 8, image: 'images/equip/drcover2.png' },
            'dch': { name: 'DCH', description: '+2% max HP', max: 8, image: 'images/equip/drcover3.png' }
        };

        const RESOURCES = {
            'darkonit': { name: 'Darkonit', laserBonus: 10, rocketBonus: 10 },
            'uranit': { name: 'Uranit', laserBonus: 8, rocketBonus: 8, shieldBonus: 8, speedBonus: 4 },
            'azurit': { name: 'Azurit', shieldBonus: 10, speedBonus: 5 },
            'dungid': { name: 'Dungid', laserBonus: 20, rocketBonus: 20 },
            'xureon': { name: 'Xureon', shieldBonus: 20, speedBonus: 10 }
        };

        let shipConfigurations = {
            1: {
                shipId: null,
                lasers: [],
                generators: [],
                drones: Array(8).fill(null).map(() => ({ covers: null, equipment: [null, null] })),
                resources: { lasers: null, rockets: null, shields: null, speed: null },
                premium: false,
                battleMode: 'x4',
                rocket: 'kep-410'
            },
            2: {
                shipId: null,
                lasers: [],
                generators: [],
                drones: Array(8).fill(null).map(() => ({ covers: null, equipment: [null, null] })),
                resources: { lasers: null, rockets: null, shields: null, speed: null },
                premium: false,
                battleMode: 'x4',
                rocket: 'kep-410'
            }
        };

        let battleState = null;
        let battleInterval = null;
        let currentBattleSpeed = 1000;

        document.addEventListener('DOMContentLoaded', function() {
            initializeShipSelectors();
            initializeEquipmentGrids();
            initializeResourceSelectors();
            initializeEventListeners();
            applyDefaultConfigurations();
            updateAllStats();
            initializeBattleUI();
            initializeSpeedControl();
        });

        function initializeShipSelectors() {
            const shipOrder = ['ship101', 'ship100', 'ship90', 'ship108', 'ship102', 'ship80', 'ship70', 'ship60', 'ship50', 'ship41', 'ship40', 'ship30', 'ship20', 'ship10'];
            
            [1, 2].forEach(shipNum => {
                const grid = document.getElementById(`ship-grid-${shipNum}`);
                
                shipOrder.forEach(shipId => {
                    const ship = SHIPS_DATA[shipId];
                    const shipItem = document.createElement('div');
                    shipItem.className = 'ship-item';
                    shipItem.dataset.shipId = shipId;
                    shipItem.innerHTML = `
                        <img src="${ship.image}" alt="${ship.name}" class="ship-icon">
                        <div class="ship-info">
                            <div class="ship-name">${ship.name}</div>
                            <div class="ship-stats">${ship.lasers}L ${ship.generators}Gen</div>
                        </div>
                    `;
                    shipItem.addEventListener('click', () => selectShip(shipNum, shipId));
                    grid.appendChild(shipItem);
                });
            });
        }

        function initializeEquipmentGrids() {
            [1, 2].forEach(shipNum => {
                const equipmentGrid = document.getElementById(`equipment-grid-${shipNum}`);
                
                Object.entries(LASER_GUNS).forEach(([key, laser]) => {
                    const item = document.createElement('div');
                    item.className = 'equipment-item';
                    item.dataset.type = 'laser';
                    item.dataset.itemKey = key;
                    item.innerHTML = `<img src="${laser.image}" alt="${laser.name}" class="equipment-icon">`;
                    item.addEventListener('click', () => showEquipmentModal(shipNum, 'laser', key));
                    equipmentGrid.appendChild(item);
                });
                
                Object.entries(SHIELD_GENERATORS).forEach(([key, shield]) => {
                    const item = document.createElement('div');
                    item.className = 'equipment-item';
                    item.dataset.type = 'shield';
                    item.dataset.itemKey = key;
                    item.innerHTML = `<img src="${shield.image}" alt="${shield.name}" class="equipment-icon">`;
                    item.addEventListener('click', () => showEquipmentModal(shipNum, 'shield', key));
                    equipmentGrid.appendChild(item);
                });
                
                const accelItem = document.createElement('div');
                accelItem.className = 'equipment-item';
                accelItem.dataset.type = 'accelerator';
                accelItem.dataset.itemKey = 'accelerator-3';
                accelItem.innerHTML = `<img src="${ACCELERATORS['accelerator-3'].image}" alt="${ACCELERATORS['accelerator-3'].name}" class="equipment-icon">`;
                accelItem.addEventListener('click', () => showEquipmentModal(shipNum, 'accelerator', 'accelerator-3'));
                equipmentGrid.appendChild(accelItem);
                
                const droneCoversGrid = document.getElementById(`drone-covers-${shipNum}`);
                
                Object.entries(DRONE_COVERS).forEach(([key, cover]) => {
                    const item = document.createElement('div');
                    item.className = 'equipment-item';
                    item.dataset.type = 'drone-cover';
                    item.dataset.itemKey = key;
                    item.innerHTML = `<img src="${cover.image}" alt="${cover.name}" class="equipment-icon">`;
                    item.addEventListener('click', () => showEquipmentModal(shipNum, 'drone-cover', key));
                    droneCoversGrid.appendChild(item);
                });
                
                const clearBtn = document.createElement('div');
                clearBtn.className = 'equipment-item clear-btn';
                clearBtn.style.background = '#ff4444';
                clearBtn.style.borderColor = '#ff6666';
                clearBtn.onclick = () => showClearModal(shipNum);
                clearBtn.innerHTML = '<div style="color: white; font-weight: bold; font-size: 24px;">✕</div>';
                droneCoversGrid.appendChild(clearBtn);
            });
        }

        function initializeResourceSelectors() {
            [1, 2].forEach(shipNum => {
                const resourceGrid = document.getElementById(`resource-grid-${shipNum}`);
                const categories = ['lasers', 'rockets', 'shields', 'speed'];
                
                categories.forEach(category => {
                    const resourceItem = document.createElement('div');
                    resourceItem.className = 'resource-item';
                    
                    const label = document.createElement('div');
                    label.className = 'resource-label';
                    label.textContent = category.charAt(0).toUpperCase() + category.slice(1);
                    resourceItem.appendChild(label);
                    
                    const select = document.createElement('select');
                    select.className = 'resource-select';
                    select.dataset.category = category;
                    
                    const noneOption = document.createElement('option');
                    noneOption.value = '';
                    noneOption.textContent = 'None';
                    select.appendChild(noneOption);
                    
                    Object.entries(RESOURCES).forEach(([key, resource]) => {
                        if (category === 'lasers' || category === 'rockets') {
                            if (resource.laserBonus !== undefined) {
                                const option = document.createElement('option');
                                option.value = key;
                                option.textContent = `${resource.name} (+${resource.laserBonus}%)`;
                                select.appendChild(option);
                            }
                        } else if (category === 'shields' || category === 'speed') {
                            if (resource.shieldBonus !== undefined) {
                                const option = document.createElement('option');
                                option.value = key;
                                const bonus = category === 'shields' ? resource.shieldBonus : resource.speedBonus;
                                option.textContent = `${resource.name} (+${bonus}%)`;
                                select.appendChild(option);
                            }
                        }
                    });
                    
                    select.addEventListener('change', (e) => {
                        shipConfigurations[shipNum].resources[category] = e.target.value || null;
                        updateStats(shipNum);
                    });
                    
                    resourceItem.appendChild(select);
                    resourceGrid.appendChild(resourceItem);
                });
            });
        }

        function initializeEventListeners() {
            [1, 2].forEach(shipNum => {
                const toggle = document.getElementById(`premium-${shipNum}`);
                toggle.addEventListener('click', () => {
                    shipConfigurations[shipNum].premium = !shipConfigurations[shipNum].premium;
                    toggle.classList.toggle('active');
                });
            });

            [1, 2].forEach(shipNum => {
                const rocketSelect = document.getElementById(`rocket-select-${shipNum}`);
                rocketSelect.addEventListener('change', (e) => {
                    shipConfigurations[shipNum].rocket = e.target.value;
                    updateStats(shipNum);
                });
            });

            document.querySelectorAll('.mode-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const shipNum = parseInt(e.target.closest('.ship-panel').id.split('-').pop());
                    const mode = e.target.dataset.mode;
                    
                    e.target.closest('.mode-buttons').querySelectorAll('.mode-btn').forEach(b => b.classList.remove('active'));
                    e.target.classList.add('active');
                    
                    shipConfigurations[shipNum].battleMode = mode;
                });
            });

            document.getElementById('equipment-modal').addEventListener('click', (e) => {
                if (e.target.id === 'equipment-modal') {
                    closeModal();
                }
            });
        }

        function initializeSpeedControl() {
            const speedSlider = document.getElementById('battle-speed');
            const speedDisplay = document.getElementById('speed-display');
            
            function updateSpeedDisplay() {
                const seconds = (speedSlider.value / 1000).toFixed(1);
                speedDisplay.textContent = `${seconds}s`;
                currentBattleSpeed = parseInt(speedSlider.value);
                
                if (battleInterval) {
                    clearInterval(battleInterval);
                    battleInterval = setInterval(simulateBattleTick, currentBattleSpeed);
                }
            }
            
            speedSlider.addEventListener('input', updateSpeedDisplay);
            
            updateSpeedDisplay();
        }


        function applyDefaultConfigurations() {
            [1, 2].forEach(shipNum => {
                const defaultShipId = 'ship101';
                
                shipConfigurations[shipNum] = {
                    shipId: defaultShipId,
                    lasers: [],
                    generators: [],
                    drones: Array(8).fill(null).map(() => ({ covers: null, equipment: [null, null] })),
                    resources: {
                        lasers: 'dungid',
                        rockets: 'dungid',
                        shields: 'xureon',
                        speed: 'xureon'
                    },
                    premium: true,
                    battleMode: 'sabx6',
                    rocket: 'tnc-130'
                };
                
                selectShip(shipNum, defaultShipId);
                
                applyDefaultEquipment(shipNum);
                
                applyDefaultResources(shipNum);
                
                applyDefaultDroneCovers(shipNum);
                
                const premiumToggle = document.getElementById(`premium-${shipNum}`);
                premiumToggle.classList.add('active');
                
                document.getElementById(`rocket-select-${shipNum}`).value = 'tnc-130';
                
                document.querySelectorAll(`#ship-panel-${shipNum} .mode-btn`).forEach(btn => {
                    btn.classList.remove('active');
                    if (btn.dataset.mode === 'sabx6') {
                        btn.classList.add('active');
                    }
                });
            });
        }

        function applyDefaultEquipment(shipNum) {
            const config = shipConfigurations[shipNum];
            const ship = SHIPS_DATA[config.shipId];
            
            if (!ship) return;
            
            for (let i = 0; i < ship.lasers; i++) {
                config.lasers[i] = 'laser-gun-4';
                updateShipSlotUI(shipNum, 'laser', i, 'laser-gun-4');
            }
            
            for (let i = 0; i < ship.generators; i++) {
                config.generators[i] = 'shield-gen-3';
                updateShipSlotUI(shipNum, 'generator', i, 'shield-gen-3');
            }
        }

        function applyDefaultResources(shipNum) {
            const resourceSelects = document.querySelectorAll(`#ship-panel-${shipNum} .resource-select`);
            resourceSelects.forEach(select => {
                const category = select.dataset.category;
                if (category === 'lasers' || category === 'rockets') {
                    select.value = 'dungid';
                } else if (category === 'shields' || category === 'speed') {
                    select.value = 'xureon';
                }
            });
        }

        function applyDefaultDroneCovers(shipNum) {
            const config = shipConfigurations[shipNum];
            
            config.drones.forEach((drone, droneIndex) => {
                drone.covers = 'dcs';
                updateDroneCoverUI(shipNum, droneIndex, 'dcs');
            });
        }

        function selectShip(shipNum, shipId) {
            const oldConfig = shipConfigurations[shipNum];
            const oldShip = oldConfig.shipId ? SHIPS_DATA[oldConfig.shipId] : null;
            const newShip = SHIPS_DATA[shipId];
            
            const newLasers = [];
            const newGenerators = [];
            
            for (let i = 0; i < newShip.lasers; i++) {
                newLasers[i] = 'laser-gun-4';
            }
            
            for (let i = 0; i < newShip.generators; i++) {
                newGenerators[i] = 'shield-gen-3';
            }
            
            const preservedDrones = oldConfig.drones ? [...oldConfig.drones] : Array(8).fill(null).map(() => ({ covers: null, equipment: [null, null] }));
            
            shipConfigurations[shipNum] = {
                shipId: shipId,
                lasers: newLasers,
                generators: newGenerators,
                drones: preservedDrones,
                resources: oldConfig.resources || { lasers: null, rockets: null, shields: null, speed: null },
                premium: oldConfig.premium || false,
                battleMode: oldConfig.battleMode || 'x4',
                rocket: oldConfig.rocket || 'kep-410'
            };
            
            document.querySelectorAll(`#ship-grid-${shipNum} .ship-item`).forEach(item => {
                item.classList.toggle('selected', item.dataset.shipId === shipId);
            });
            
            initializeShipSlots(shipNum);
            initializeDroneSlots(shipNum);
            
            updateStats(shipNum);
        }

        function initializeShipSlots(shipNum) {
            const config = shipConfigurations[shipNum];
            const ship = SHIPS_DATA[config.shipId];
            const slotsContainer = document.getElementById(`ship-slots-${shipNum}`);
            slotsContainer.innerHTML = '';
            
            if (!ship) return;
            
            if (!config.lasers) config.lasers = [];
            if (!config.generators) config.generators = [];
            
            for (let i = 0; i < ship.lasers; i++) {
                const slot = document.createElement('div');
                slot.className = 'slot';
                slot.dataset.slotType = 'laser';
                slot.dataset.slotIndex = i;
                slot.innerHTML = '<div class="slot-label">LG</div>';
                slot.addEventListener('click', () => showSlotModal(shipNum, 'laser', i));
                slotsContainer.appendChild(slot);
                
                if (config.lasers[i]) {
                    updateShipSlotUI(shipNum, 'laser', i, config.lasers[i]);
                }
            }
            
            for (let i = 0; i < ship.generators; i++) {
                const slot = document.createElement('div');
                slot.className = 'slot';
                slot.dataset.slotType = 'generator';
                slot.dataset.slotIndex = i;
                slot.innerHTML = '<div class="slot-label">Gen</div>';
                slot.addEventListener('click', () => showSlotModal(shipNum, 'generator', i));
                slotsContainer.appendChild(slot);
                
                if (config.generators[i]) {
                    updateShipSlotUI(shipNum, 'generator', i, config.generators[i]);
                }
            }
        }

        function initializeDroneSlots(shipNum) {
            const config = shipConfigurations[shipNum];
            const droneGrid = document.getElementById(`drone-grid-${shipNum}`);
            droneGrid.innerHTML = '';
            
            if (!config.drones) {
                config.drones = Array(8).fill(null).map(() => ({ covers: null, equipment: [null, null] }));
            }
            
            for (let i = 0; i < 8; i++) {
                const droneBlock = document.createElement('div');
                droneBlock.className = 'drone-block';
                
                const droneIcon = document.createElement('img');
                droneIcon.src = 'images/drones/drone2.png';
                droneIcon.className = 'drone-icon';
                droneBlock.appendChild(droneIcon);
                
                const droneSlots = document.createElement('div');
                droneSlots.className = 'drone-slots';
                
                const coverSlot = document.createElement('div');
                coverSlot.className = 'drone-slot';
                coverSlot.dataset.droneIndex = i;
                coverSlot.dataset.slotType = 'cover';
                coverSlot.addEventListener('click', () => showDroneSlotModal(shipNum, i, 'cover'));
                droneSlots.appendChild(coverSlot);
                
                for (let j = 0; j < 2; j++) {
                    const slot = document.createElement('div');
                    slot.className = 'drone-slot';
                    slot.dataset.droneIndex = i;
                    slot.dataset.slotType = 'equipment';
                    slot.dataset.equipmentIndex = j;
                    slot.addEventListener('click', () => showDroneSlotModal(shipNum, i, 'equipment', j));
                    droneSlots.appendChild(slot);
                }
                
                droneBlock.appendChild(droneSlots);
                droneGrid.appendChild(droneBlock);
                
                if (config.drones[i]) {
                    if (config.drones[i].covers) {
                        updateDroneCoverUI(shipNum, i, config.drones[i].covers);
                    }
                    config.drones[i].equipment.forEach((equipment, equipmentIndex) => {
                        if (equipment) {
                            updateDroneSlotUI(shipNum, i, equipmentIndex, equipment);
                        }
                    });
                }
            }
        }

        function showEquipmentModal(shipNum, type, itemKey) {
            const modal = document.getElementById('equipment-modal');
            const modalTitle = document.getElementById('modal-title');
            const modalOptions = document.getElementById('modal-options');
            
            modalTitle.textContent = `Select Action - ${getItemName(type, itemKey)}`;
            modalOptions.innerHTML = '';
            
            modalOptions.className = 'modal-options';
            
            if (type === 'drone-cover') {
                const cover = DRONE_COVERS[itemKey];
                const fillOption = document.createElement('div');
                fillOption.className = 'modal-option';
                fillOption.textContent = `Fill drones with ${cover.name} (max ${cover.max})`;
                fillOption.addEventListener('click', () => {
                    fillDroneCovers(shipNum, itemKey);
                    closeModal();
                });
                modalOptions.appendChild(fillOption);
            } else {
                const fillShipOption = document.createElement('div');
                fillShipOption.className = 'modal-option';
                fillShipOption.textContent = `Fill ship with ${getItemName(type, itemKey)}`;
                fillShipOption.addEventListener('click', () => {
                    if (type === 'accelerator') {
                        fillShipSlots(shipNum, 'accelerator', itemKey);
                    } else {
                        fillShipSlots(shipNum, type, itemKey);
                    }
                    closeModal();
                });
                modalOptions.appendChild(fillShipOption);
                
                if (type === 'laser' || type === 'shield') {
                    const fillDronesOption = document.createElement('div');
                    fillDronesOption.className = 'modal-option';
                    fillDronesOption.textContent = `Fill drones with ${getItemName(type, itemKey)}`;
                    fillDronesOption.addEventListener('click', () => {
                        fillDroneEquipment(shipNum, type, itemKey);
                        closeModal();
                    });
                    modalOptions.appendChild(fillDronesOption);
                }
            }
            
            modal.style.display = 'flex';
        }

        function showSlotModal(shipNum, slotType, slotIndex) {
            const modal = document.getElementById('equipment-modal');
            const modalTitle = document.getElementById('modal-title');
            const modalOptions = document.getElementById('modal-options');
            
            modalTitle.textContent = `Select Equipment for ${slotType.toUpperCase()} Slot ${slotIndex + 1}`;
            modalOptions.innerHTML = '';
            
            modalOptions.className = 'modal-options icon-grid';
            
            if (slotType === 'laser') {
                Object.entries(LASER_GUNS).forEach(([key, laser]) => {
                    const option = document.createElement('div');
                    option.className = 'modal-option icon-option';
                    option.innerHTML = `
                        <img src="${laser.image}" alt="${laser.name}" class="equipment-icon">
                        <div class="icon-label">${laser.shortName}</div>
                    `;
                    option.addEventListener('click', () => {
                        equipShipSlot(shipNum, 'laser', slotIndex, key);
                        closeModal();
                    });
                    modalOptions.appendChild(option);
                });
            } else if (slotType === 'generator') {
                Object.entries(SHIELD_GENERATORS).forEach(([key, shield]) => {
                    const option = document.createElement('div');
                    option.className = 'modal-option icon-option';
                    option.innerHTML = `
                        <img src="${shield.image}" alt="${shield.name}" class="equipment-icon">
                        <div class="icon-label">${shield.shortName}</div>
                    `;
                    option.addEventListener('click', () => {
                        equipShipSlot(shipNum, 'generator', slotIndex, key);
                        closeModal();
                    });
                    modalOptions.appendChild(option);
                });
                
                const accelOption = document.createElement('div');
                accelOption.className = 'modal-option icon-option';
                accelOption.innerHTML = `
                    <img src="${ACCELERATORS['accelerator-3'].image}" alt="${ACCELERATORS['accelerator-3'].name}" class="equipment-icon">
                    <div class="icon-label">${ACCELERATORS['accelerator-3'].shortName}</div>
                `;
                accelOption.addEventListener('click', () => {
                    equipShipSlot(shipNum, 'generator', slotIndex, 'accelerator-3');
                    closeModal();
                });
                modalOptions.appendChild(accelOption);
            }
            
            modal.style.display = 'flex';
        }

        function showDroneSlotModal(shipNum, droneIndex, slotType, equipmentIndex = 0) {
            const modal = document.getElementById('equipment-modal');
            const modalTitle = document.getElementById('modal-title');
            const modalOptions = document.getElementById('modal-options');
            
            modalTitle.textContent = `Select Equipment for Drone ${droneIndex + 1} - ${slotType.toUpperCase()}`;
            modalOptions.innerHTML = '';
            
            modalOptions.className = 'modal-options icon-grid';
            
            if (slotType === 'cover') {
                Object.entries(DRONE_COVERS).forEach(([key, cover]) => {
                    const option = document.createElement('div');
                    option.className = 'modal-option icon-option';
                    option.innerHTML = `
                        <img src="${cover.image}" alt="${cover.name}" class="equipment-icon">
                        <div class="icon-label">${cover.name}</div>
                    `;
                    option.addEventListener('click', () => {
                        equipDroneCover(shipNum, droneIndex, key);
                        closeModal();
                    });
                    modalOptions.appendChild(option);
                });
            } else if (slotType === 'equipment') {
                Object.entries(LASER_GUNS).forEach(([key, laser]) => {
                    const option = document.createElement('div');
                    option.className = 'modal-option icon-option';
                    option.innerHTML = `
                        <img src="${laser.image}" alt="${laser.name}" class="equipment-icon">
                        <div class="icon-label">${laser.shortName}</div>
                    `;
                    option.addEventListener('click', () => {
                        equipDroneSlot(shipNum, droneIndex, equipmentIndex, key);
                        closeModal();
                    });
                    modalOptions.appendChild(option);
                });
                
                Object.entries(SHIELD_GENERATORS).forEach(([key, shield]) => {
                    const option = document.createElement('div');
                    option.className = 'modal-option icon-option';
                    option.innerHTML = `
                        <img src="${shield.image}" alt="${shield.name}" class="equipment-icon">
                        <div class="icon-label">${shield.shortName}</div>
                    `;
                    option.addEventListener('click', () => {
                        equipDroneSlot(shipNum, droneIndex, equipmentIndex, key);
                        closeModal();
                    });
                    modalOptions.appendChild(option);
                });
            }
            
            modal.style.display = 'flex';
        }

        function closeModal() {
            document.getElementById('equipment-modal').style.display = 'none';
        }

        function equipShipSlot(shipNum, slotType, slotIndex, itemKey) {
            const config = shipConfigurations[shipNum];
            
            if (slotType === 'laser') {
                config.lasers[slotIndex] = itemKey;
            } else if (slotType === 'generator') {
                config.generators[slotIndex] = itemKey;
            }
            
            updateShipSlotUI(shipNum, slotType, slotIndex, itemKey);
            updateStats(shipNum);
        }

        function equipDroneSlot(shipNum, droneIndex, equipmentIndex, itemKey) {
            shipConfigurations[shipNum].drones[droneIndex].equipment[equipmentIndex] = itemKey;
            updateDroneSlotUI(shipNum, droneIndex, equipmentIndex, itemKey);
            updateStats(shipNum);
        }

        function equipDroneCover(shipNum, droneIndex, coverKey) {
            const config = shipConfigurations[shipNum];
            const cover = DRONE_COVERS[coverKey];
            
            if (coverKey === 'dcd') {
                const currentDCDCount = config.drones.filter(d => d.covers === 'dcd').length;
                if (currentDCDCount >= cover.max) {
                    alert(`Maximum ${cover.max} DCD covers allowed!`);
                    return;
                }
            }
            
            config.drones[droneIndex].covers = coverKey;
            updateDroneCoverUI(shipNum, droneIndex, coverKey);
            updateStats(shipNum);
        }

        function fillShipSlots(shipNum, type, itemKey) {
            const config = shipConfigurations[shipNum];
            const ship = SHIPS_DATA[config.shipId];
            
            if (type === 'laser') {
                for (let i = 0; i < ship.lasers; i++) {
                    config.lasers[i] = itemKey;
                    updateShipSlotUI(shipNum, 'laser', i, itemKey);
                }
            } else if (type === 'shield') {
                for (let i = 0; i < ship.generators; i++) {
                    config.generators[i] = itemKey;
                    updateShipSlotUI(shipNum, 'generator', i, itemKey);
                }
            } else if (type === 'accelerator') {
                for (let i = 0; i < ship.generators; i++) {
                    config.generators[i] = itemKey;
                    updateShipSlotUI(shipNum, 'generator', i, itemKey);
                }
            }
            
            updateStats(shipNum);
        }

        function fillDroneEquipment(shipNum, type, itemKey) {
            const config = shipConfigurations[shipNum];
            
            config.drones.forEach((drone, droneIndex) => {
                drone.equipment.forEach((slot, equipmentIndex) => {
                    if (type === 'laser' || type === 'shield') {
                        drone.equipment[equipmentIndex] = itemKey;
                        updateDroneSlotUI(shipNum, droneIndex, equipmentIndex, itemKey);
                    }
                });
            });
            
            updateStats(shipNum);
        }

        function fillDroneCovers(shipNum, coverKey) {
            const config = shipConfigurations[shipNum];
            const cover = DRONE_COVERS[coverKey];
            
            let count = 0;
            config.drones.forEach((drone, droneIndex) => {
                if (count < cover.max || coverKey !== 'dcd') {
                    drone.covers = coverKey;
                    updateDroneCoverUI(shipNum, droneIndex, coverKey);
                    count++;
                }
            });
            
            updateStats(shipNum);
        }

        function updateShipSlotUI(shipNum, slotType, slotIndex, itemKey) {
            const slots = document.querySelectorAll(`#ship-slots-${shipNum} .slot`);
            
            slots.forEach(slot => {
                if (slot.dataset.slotType === slotType && parseInt(slot.dataset.slotIndex) === slotIndex) {
                    if (itemKey) {
                        let item = null;
                        let itemType = slotType;
                        
                        if (slotType === 'laser') {
                            item = LASER_GUNS[itemKey];
                        } else if (slotType === 'generator') {
                            if (SHIELD_GENERATORS[itemKey]) {
                                item = SHIELD_GENERATORS[itemKey];
                            } else if (ACCELERATORS[itemKey]) {
                                item = ACCELERATORS[itemKey];
                            }
                        }
                        
                        if (item && item.image) {
                            slot.innerHTML = `
                                <img src="${item.image}" alt="${item.name}" class="equipment-icon">
                                <div class="slot-label">${slotType === 'laser' ? 'LG' : 'Gen'}</div>
                            `;
                            slot.classList.add('occupied');
                        } else if (item) {
                            slot.innerHTML = `
                                <div class="slot-label">${slotType === 'laser' ? 'LG' : 'Gen'}</div>
                            `;
                            slot.classList.add('occupied');
                        } else {
                            slot.innerHTML = `<div class="slot-label">${slotType === 'laser' ? 'LG' : 'Gen'}</div>`;
                            slot.classList.remove('occupied');
                        }
                    } else {
                        slot.innerHTML = `<div class="slot-label">${slotType === 'laser' ? 'LG' : 'Gen'}</div>`;
                        slot.classList.remove('occupied');
                    }
                }
            });
        }

        function updateDroneSlotUI(shipNum, droneIndex, equipmentIndex, itemKey) {
            const slot = document.querySelector(
                `#drone-grid-${shipNum} .drone-block:nth-child(${droneIndex + 1}) .drone-slot[data-equipment-index="${equipmentIndex}"]`
            );
            
            if (slot) {
                if (itemKey) {
                    const item = getItemData('laser', itemKey) || getItemData('shield', itemKey);
                    if (item && item.image) {
                        slot.innerHTML = `<img src="${item.image}" alt="${item.name}" style="width: 30px; height: 30px;">`;
                        slot.style.background = '#444';
                    } else {
                        slot.innerHTML = '';
                        slot.style.background = '#222';
                    }
                } else {
                    slot.innerHTML = '';
                    slot.style.background = '#222';
                }
            }
        }

        function updateDroneCoverUI(shipNum, droneIndex, coverKey) {
            const slot = document.querySelector(
                `#drone-grid-${shipNum} .drone-block:nth-child(${droneIndex + 1}) .drone-slot[data-slot-type="cover"]`
            );
            
            if (slot) {
                if (coverKey) {
                    const cover = DRONE_COVERS[coverKey];
                    if (cover && cover.image) {
                        slot.innerHTML = `<img src="${cover.image}" alt="${cover.name}" style="width: 30px; height: 30px;">`;
                        slot.style.background = '#444';
                    } else {
                        slot.innerHTML = '';
                        slot.style.background = '#222';
                    }
                } else {
                    slot.innerHTML = '';
                    slot.style.background = '#222';
                }
            }
        }

        function updateDroneSlotUI(shipNum, droneIndex, equipmentIndex, itemKey) {
            const slot = document.querySelector(
                `#drone-grid-${shipNum} .drone-block:nth-child(${droneIndex + 1}) .drone-slot[data-equipment-index="${equipmentIndex}"]`
            );
            
            if (slot && itemKey) {
                const item = getItemData('laser', itemKey) || getItemData('shield', itemKey);
                slot.innerHTML = `<img src="${item.image}" alt="${item.name}" style="width: 30px; height: 30px;">`;
                slot.style.background = '#444';
            }
        }

        function updateDroneCoverUI(shipNum, droneIndex, coverKey) {
            const slot = document.querySelector(
                `#drone-grid-${shipNum} .drone-block:nth-child(${droneIndex + 1}) .drone-slot[data-slot-type="cover"]`
            );
            
            if (slot && coverKey) {
                const cover = DRONE_COVERS[coverKey];
                slot.innerHTML = `<img src="${cover.image}" alt="${cover.name}" style="width: 30px; height: 30px;">`;
                slot.style.background = '#444';
            }
        }

        function getItemData(type, itemKey) {
            if (type === 'laser') return LASER_GUNS[itemKey];
            if (type === 'shield') return SHIELD_GENERATORS[itemKey];
            if (type === 'accelerator') return ACCELERATORS[itemKey];
            if (type === 'drone-cover') return DRONE_COVERS[itemKey];
            return null;
        }

        function getItemName(type, itemKey) {
            const item = getItemData(type, itemKey);
            return item ? item.name : itemKey;
        }

        function equipShipSlot(shipNum, slotType, slotIndex, itemKey) {
            const config = shipConfigurations[shipNum];
            
            if (!config.lasers) config.lasers = [];
            if (!config.generators) config.generators = [];
            
            if (slotType === 'laser') {
                config.lasers[slotIndex] = itemKey;
            } else if (slotType === 'generator') {
                config.generators[slotIndex] = itemKey;
            }
            
            updateShipSlotUI(shipNum, slotType, slotIndex, itemKey);
            updateStats(shipNum);
        }

        function equipDroneSlot(shipNum, droneIndex, equipmentIndex, itemKey) {
            const config = shipConfigurations[shipNum];
            
            if (!config.drones) {
                config.drones = Array(8).fill(null).map(() => ({ covers: null, equipment: [null, null] }));
            }
            
            config.drones[droneIndex].equipment[equipmentIndex] = itemKey;
            updateDroneSlotUI(shipNum, droneIndex, equipmentIndex, itemKey);
            updateStats(shipNum);
        }

        function equipDroneCover(shipNum, droneIndex, coverKey) {
            const config = shipConfigurations[shipNum];
            const cover = DRONE_COVERS[coverKey];
            
            if (!config.drones) {
                config.drones = Array(8).fill(null).map(() => ({ covers: null, equipment: [null, null] }));
            }
            
            if (coverKey === 'dcd') {
                const currentDCDCount = config.drones.filter(d => d.covers === 'dcd').length;
                if (currentDCDCount >= cover.max) {
                    alert(`Maximum ${cover.max} DCD covers allowed!`);
                    return;
                }
            }
            
            config.drones[droneIndex].covers = coverKey;
            updateDroneCoverUI(shipNum, droneIndex, coverKey);
            updateStats(shipNum);
        }

        function updateStats(shipNum) {
            const config = shipConfigurations[shipNum];
            const ship = SHIPS_DATA[config.shipId];
            if (!ship) return;
            
            const stats = calculateShipStats(config);
            const statsGrid = document.getElementById(`stats-grid-${shipNum}`);
            
            statsGrid.innerHTML = `
                <div class="stat-item">
                    <div class="stat-label">Hitpoints</div>
                    <div class="stat-value">${formatNumber(stats.totalHP)}</div>
                </div>
                <div class="stat-item">
                    <div class="stat-label">Total Shields</div>
                    <div class="stat-value">${formatNumber(stats.totalShields)}</div>
                </div>
                <div class="stat-item">
                    <div class="stat-label">Laser Damage</div>
                    <div class="stat-value">[x1: ${formatNumber(stats.totalLaserDamage)} ]  [x4: ${formatNumber(stats.totalLaserDamage * 4)} ]</div>
                </div>
                <div class="stat-item">
                    <div class="stat-label">Absorption</div>
                    <div class="stat-value">${stats.absorption.toFixed(1)}%</div>
                </div>
            `;
        }

        function updateAllStats() {
            [1, 2].forEach(shipNum => updateStats(shipNum));
        }

        function calculateShipStats(config) {
            const ship = SHIPS_DATA[config.shipId];
            if (!ship) return { totalHP: 0, totalShields: 0, speed: 0, totalLaserDamage: 0, totalDamage: 0, absorption: 0 };
            
            let totalHP = ship.hp;
            let totalShields = 0;
            let totalLaserDamage = 0;
            let totalDamage = 0;
            let totalAbsorption = 0;
            let shieldCount = 0;
            
            const laserResourceBonus = config.resources.lasers ? (RESOURCES[config.resources.lasers].laserBonus || 0) / 100 + 1 : 1;
            const shieldResourceBonus = config.resources.shields ? (RESOURCES[config.resources.shields].shieldBonus || 0) / 100 + 1 : 1;
            const rocketResourceBonus = config.resources.rockets ? (RESOURCES[config.resources.rockets].rocketBonus || 0) / 100 + 1 : 1;
            
            config.lasers.forEach(laserKey => {
                if (laserKey) {
                    const laser = LASER_GUNS[laserKey];
                    totalLaserDamage += laser.damage * laserResourceBonus;
                }
            });
            
            config.generators.forEach(genKey => {
                if (genKey && SHIELD_GENERATORS[genKey]) {
                    const shield = SHIELD_GENERATORS[genKey];
                    totalShields += shield.hp * shieldResourceBonus;
                    totalAbsorption += shield.absorption;
                    shieldCount++;
                }
            });
            
            let dchCount = 0;
            let dcsCount = 0;
            let dcdCount = 0;
            
            config.drones.forEach(drone => {
                if (drone.covers === 'dch') dchCount++;
                if (drone.covers === 'dcs') dcsCount++;
                if (drone.covers === 'dcd') dcdCount++;
                
                drone.equipment.forEach(equipmentKey => {
                    if (equipmentKey) {
                        if (LASER_GUNS[equipmentKey]) {
                            const laser = LASER_GUNS[equipmentKey];
                            let damage = laser.damage * 1.05;
                            
                            if (drone.covers === 'dcd') {
                                damage *= 1.05;
                            }
                            
                            damage *= laserResourceBonus;
                            totalLaserDamage += damage;
                        } else if (SHIELD_GENERATORS[equipmentKey]) {
                            const shield = SHIELD_GENERATORS[equipmentKey];
                            let shieldHP = shield.hp * 1.10;
                            
                            if (drone.covers === 'dcs') {
                                shieldHP *= 1.10;
                            }
                            
                            shieldHP *= shieldResourceBonus;
                            totalShields += shieldHP;
                            totalAbsorption += shield.absorption;
                            shieldCount++;
                        }
                    }
                });
            });
            

            totalDamage = totalLaserDamage;
            
            if (dchCount === 8) {
                totalHP *= 1.16;
            } else {
                totalHP *= (1 + dchCount * 0.02);
            }
            
            if (dcsCount === 8) {
                config.drones.forEach(drone => {
                    drone.equipment.forEach(equipmentKey => {
                        if (equipmentKey && SHIELD_GENERATORS[equipmentKey]) {
                            const shield = SHIELD_GENERATORS[equipmentKey];
                            const baseShieldHP = shield.hp * 1.10;
                            const dcsBonus = baseShieldHP * 0.10;
                            totalShields += dcsBonus * shieldResourceBonus;
                        }
                    });
                });
            }
            
            const absorption = shieldCount > 0 ? totalAbsorption / shieldCount : 0;
            
            return {
                totalHP: Math.round(totalHP),
                totalShields: Math.round(totalShields),
                speed: ship.speed,
                totalLaserDamage: Math.round(totalLaserDamage),
                totalDamage: Math.round(totalDamage),
                absorption: absorption
            };
        }

        function formatNumber(num) {
            return num.toString().replace(/\B(?=(\d{3})+(?!\d))/g, " ");
        }

        function saveConfiguration() {
            const config = {
                ship1: shipConfigurations[1],
                ship2: shipConfigurations[2]
            };
            
            const configString = JSON.stringify(config);
            const base64String = btoa(configString);
            
            document.getElementById('save-input').value = base64String;
            navigator.clipboard.writeText(base64String).then(() => {
                alert('Configuration saved to clipboard!');
            });
        }

        function loadConfiguration() {
            const base64String = document.getElementById('save-input').value.trim();
            if (!base64String) {
                alert('Please paste a configuration string!');
                return;
            }
            
            try {
                const configString = atob(base64String);
                const config = JSON.parse(configString);
                
                shipConfigurations[1] = config.ship1;
                shipConfigurations[2] = config.ship2;
                
                [1, 2].forEach(shipNum => {
                    const config = shipConfigurations[shipNum];
                    
                    if (config.shipId) {
                        selectShip(shipNum, config.shipId);
                    }
                    
                    const premiumToggle = document.getElementById(`premium-${shipNum}`);
                    premiumToggle.classList.toggle('active', config.premium);
                    
                    document.querySelectorAll(`#ship-panel-${shipNum} .mode-btn`).forEach(btn => {
                        btn.classList.toggle('active', btn.dataset.mode === config.battleMode);
                    });
                    
                    Object.entries(config.resources).forEach(([category, resource]) => {
                        const select = document.querySelector(`#ship-panel-${shipNum} .resource-select[data-category="${category}"]`);
                        if (select) {
                            select.value = resource || '';
                        }
                    });
                });
                
                updateAllStats();
                alert('Configuration loaded successfully!');
            } catch (error) {
                alert('Invalid configuration string!');
            }
        }

        function startBattle() {
            if (!shipConfigurations[1].shipId || !shipConfigurations[2].shipId) {
                alert('Please select ships for both sides!');
                return;
            }
            
            if (battleInterval) {
                return;
            }
            
            const originalBattleMode1 = shipConfigurations[1].battleMode;
            const originalBattleMode2 = shipConfigurations[2].battleMode;
            
            battleState = {
                ship1: {
                    config: shipConfigurations[1],
                    stats: calculateShipStats(shipConfigurations[1]),
                    currentHP: calculateShipStats(shipConfigurations[1]).totalHP,
                    currentShields: calculateShipStats(shipConfigurations[1]).totalShields,
                    x6Cooldown: 0,
                    lastRocketFire: 0,
                    originalBattleMode: originalBattleMode1
                },
                ship2: {
                    config: shipConfigurations[2],
                    stats: calculateShipStats(shipConfigurations[2]),
                    currentHP: calculateShipStats(shipConfigurations[2]).totalHP,
                    currentShields: calculateShipStats(shipConfigurations[2]).totalShields,
                    x6Cooldown: 0,
                    lastRocketFire: 0,
                    originalBattleMode: originalBattleMode2
                },
                time: 0,
                log: [],
                totalDamage1: 0,
                totalDamage2: 0
            };
            
            const ship1Log = document.getElementById('ship1-battle-log');
            const ship2Log = document.getElementById('ship2-battle-log');
            ship1Log.innerHTML = '<div class="ship-log-header">Ship 1</div>';
            ship2Log.innerHTML = '<div class="ship-log-header">Ship 2</div>';
            ship1Log.classList.remove('empty');
            ship2Log.classList.remove('empty');
            
            document.getElementById('battle-stats').classList.remove('empty');
            
            document.getElementById('battle-history-container').style.display = 'grid';
            document.getElementById('history-content-1').innerHTML = '';
            document.getElementById('history-content-2').innerHTML = '';
            
            battleInterval = setInterval(simulateBattleTick, currentBattleSpeed);
        }

        function simulateBattleTick() {
            if (!battleState) return;
            
            battleState.time++;
            const time = battleState.time;
            
            const prevShip1HP = battleState.ship1.currentHP;
            const prevShip1Shields = battleState.ship1.currentShields;
            const prevShip2HP = battleState.ship2.currentHP;
            const prevShip2Shields = battleState.ship2.currentShields;
            
            const ship1SABResult = handleSABAttack(battleState.ship1, battleState.ship2);
            const ship2SABResult = handleSABAttack(battleState.ship2, battleState.ship1);
            
            const ship1AdditionalDamage = handleAdditionalAttacks(battleState.ship1, battleState.ship2);
            const ship2AdditionalDamage = handleAdditionalAttacks(battleState.ship2, battleState.ship1);
            
            if (ship1SABResult.sabRestore > 0) {
                battleState.ship1.currentShields = Math.min(
                    battleState.ship1.currentShields + ship1SABResult.sabRestore,
                    battleState.ship1.stats.totalShields
                );
            }
            
            if (ship2SABResult.sabRestore > 0) {
                battleState.ship2.currentShields = Math.min(
                    battleState.ship2.currentShields + ship2SABResult.sabRestore,
                    battleState.ship2.stats.totalShields
                );
            }
            
            const ship1Damage = {
                total: ship1SABResult.actualSabDamage + ship1AdditionalDamage.x6 + ship1AdditionalDamage.laser + ship1AdditionalDamage.rocket,
                sab: ship1SABResult.actualSabDamage,
                x6: ship1AdditionalDamage.x6,
                laser: ship1AdditionalDamage.laser,
                rocket: ship1AdditionalDamage.rocket,
                sabRestore: ship1SABResult.sabRestore,
                modeSwitch: ship1SABResult.modeSwitch
            };
            
            const ship2Damage = {
                total: ship2SABResult.actualSabDamage + ship2AdditionalDamage.x6 + ship2AdditionalDamage.laser + ship2AdditionalDamage.rocket,
                sab: ship2SABResult.actualSabDamage,
                x6: ship2AdditionalDamage.x6,
                laser: ship2AdditionalDamage.laser,
                rocket: ship2AdditionalDamage.rocket,
                sabRestore: ship2SABResult.sabRestore,
                modeSwitch: ship2SABResult.modeSwitch
            };
            
            battleState.totalDamage1 += ship1Damage.total;
            battleState.totalDamage2 += ship2Damage.total;
            
            battleState.ship1.x6Cooldown = Math.max(0, battleState.ship1.x6Cooldown - 1);
            battleState.ship2.x6Cooldown = Math.max(0, battleState.ship2.x6Cooldown - 1);
            
            logBattleTick(time, ship1Damage, ship2Damage);
            
            recordBattleHistory(time, prevShip1HP, prevShip1Shields, prevShip2HP, prevShip2Shields, ship1Damage, ship2Damage);
            
            updateBattleUI();
            
            if (battleState.ship1.currentHP <= 0 || battleState.ship2.currentHP <= 0 || time >= 200) {
                endBattle();
            }
        }
        
        function handleSABAttack(attacker, defender) {
            const config = attacker.config;
            const stats = attacker.stats;
            let actualSabDamage = 0;
            let sabRestore = 0;
            let modeSwitch = null;
            
            if (config.battleMode === 'sabx6') {
                const potentialSabDamage = stats.totalLaserDamage * 3;
                
                if (defender.currentShields < potentialSabDamage) {
                    config.battleMode = 'x4x6';
                    modeSwitch = 'x4/x6';
                    actualSabDamage = 0;
                    sabRestore = 0;
                } else {
                    actualSabDamage = potentialSabDamage;
                    defender.currentShields -= actualSabDamage;
                    
                    const baseRestore = actualSabDamage * 0.5;
                    sabRestore = Math.min(baseRestore, defender.currentShields);
                }
            }
            
            return {
                actualSabDamage: actualSabDamage,
                sabRestore: sabRestore,
                modeSwitch: modeSwitch
            };
        }

        
        function handleAdditionalAttacks(attacker, defender) {
            const config = attacker.config;
            const stats = attacker.stats;
            let laserDamage = 0;
            let rocketDamage = 0;
            let x6Damage = 0;
            
            if (config.battleMode === 'x4') {
                laserDamage = stats.totalLaserDamage * 4;
            } else if (config.battleMode === 'x4x6') {
                laserDamage = stats.totalLaserDamage * 4;
                
                if (attacker.x6Cooldown === 0) {
                    x6Damage = stats.totalLaserDamage * 6;
                    attacker.x6Cooldown = 3;
                }
            } else if (config.battleMode === 'sabx6') {
                if (attacker.x6Cooldown === 0) {
                    x6Damage = stats.totalLaserDamage * 6;
                    attacker.x6Cooldown = 3;
                }
            }
            
            const rocketInterval = config.premium ? 1 : 2;
            if (battleState.time % rocketInterval === 0) {
                const rocketKey = config.rocket || 'kep-410';
                if (rocketKey !== 'none' && ROCKETS[rocketKey]) {
                    const rocketResourceBonus = config.resources.rockets
                        ? (RESOURCES[config.resources.rockets].rocketBonus || 0) / 100 + 1
                        : 1;
                    rocketDamage = ROCKETS[rocketKey].damage * rocketResourceBonus;
                }
            }
            
            const totalDamage = laserDamage + x6Damage + rocketDamage;
            
            if (totalDamage > 0) {
                const absorption = defender.stats.absorption / 100;
                
                const shieldLoss = totalDamage * absorption;
                const hpLoss = totalDamage * (1 - absorption);
                
                defender.currentShields -= shieldLoss;
                
                if (defender.currentShields < 0) {
                    const overflow = -defender.currentShields;
                    defender.currentShields = 0;
                    defender.currentHP -= overflow;
                }
                
                defender.currentHP -= hpLoss;
            }
            
            return {
                laser: laserDamage,
                rocket: rocketDamage,
                x6: x6Damage
            };
        }


        function logBattleTick(time, ship1Damage, ship2Damage) {
            const ship1Log = document.getElementById('ship1-battle-log');
            const ship2Log = document.getElementById('ship2-battle-log');
            
            if (ship1Damage.total > 0 || ship1Damage.sab > 0) {
                const entry1 = document.createElement('div');
                entry1.className = 'ship-log-entry';
                
                let logText1 = `T${time}: ${formatNumber(Math.round(ship1Damage.total))} damage`;
                
                if (ship1Damage.modeSwitch) {
                    logText1 += `  (Switched mode to ${ship1Damage.modeSwitch})`;
                }
                
                if (ship1Damage.x6 > 0 || ship1Damage.laser > 0 || ship1Damage.sab > 0 || ship1Damage.rocket > 0) {
                    const components = [];
                    if (ship1Damage.x6 > 0) components.push(`X6: ${formatNumber(Math.round(ship1Damage.x6))}`);
                    if (ship1Damage.laser > 0) components.push(`X4: ${formatNumber(Math.round(ship1Damage.laser))}`);
                    if (ship1Damage.sab > 0) components.push(`SAB: ${formatNumber(Math.round(ship1Damage.sab))}`);
                    if (ship1Damage.rocket > 0) components.push(`Rocket: ${formatNumber(Math.round(ship1Damage.rocket))}`);
                    
                    logText1 += `<br>(${components.join(') (')})`;
                }
                
                entry1.innerHTML = logText1;
                ship1Log.appendChild(entry1);
            }
            
            if (ship2Damage.total > 0 || ship2Damage.sab > 0) {
                const entry2 = document.createElement('div');
                entry2.className = 'ship-log-entry';
                
                let logText2 = `T${time}: ${formatNumber(Math.round(ship2Damage.total))} damage`;
                
                if (ship2Damage.modeSwitch) {
                    logText2 += `  (Switched mode to ${ship2Damage.modeSwitch})`;
                }
                
                if (ship2Damage.x6 > 0 || ship2Damage.laser > 0 || ship2Damage.sab > 0 || ship2Damage.rocket > 0) {
                    const components = [];
                    if (ship2Damage.x6 > 0) components.push(`X6: ${formatNumber(Math.round(ship2Damage.x6))}`);
                    if (ship2Damage.laser > 0) components.push(`X4: ${formatNumber(Math.round(ship2Damage.laser))}`);
                    if (ship2Damage.sab > 0) components.push(`SAB: ${formatNumber(Math.round(ship2Damage.sab))}`);
                    if (ship2Damage.rocket > 0) components.push(`Rocket: ${formatNumber(Math.round(ship2Damage.rocket))}`);
                    
                    logText2 += `<br>(${components.join(') (')})`;
                }
                
                entry2.innerHTML = logText2;
                ship2Log.appendChild(entry2);
            }
            
            ship1Log.scrollTop = ship1Log.scrollHeight;
            ship2Log.scrollTop = ship2Log.scrollHeight;
        }

        function updateBattleUI() {
            if (!battleState) return;
            
            const ship1 = battleState.ship1;
            const ship2 = battleState.ship2;
            
            const battleStats = document.getElementById('battle-stats');
            battleStats.classList.remove('empty');
            battleStats.innerHTML = `
                <div class="ship-status-box">
                    <div class="ship-name-header">Ship 1</div>
                    <div class="hp-shield-combo">
                        <div class="stat-value">${formatNumber(Math.round(ship1.currentHP))} / ${formatNumber(ship1.stats.totalHP)}</div>
                        <div class="hp-bar">
                            <div class="hp-fill" style="width: ${Math.max(0, Math.min(100, (ship1.currentHP / ship1.stats.totalHP) * 100))}%"></div>
                        </div>
                        <div class="stat-value">${formatNumber(Math.round(ship1.currentShields))} / ${formatNumber(ship1.stats.totalShields)}</div>
                        <div class="shield-bar">
                            <div class="shield-fill" style="width: ${Math.max(0, Math.min(100, (ship1.currentShields / ship1.stats.totalShields) * 100))}%"></div>
                        </div>
                    </div>
                </div>
                <div class="ship-status-box">
                    <div class="ship-name-header">Ship 2</div>
                    <div class="hp-shield-combo">
                        <div class="stat-value">${formatNumber(Math.round(ship2.currentHP))} / ${formatNumber(ship2.stats.totalHP)}</div>
                        <div class="hp-bar">
                            <div class="hp-fill" style="width: ${Math.max(0, Math.min(100, (ship2.currentHP / ship2.stats.totalHP) * 100))}%"></div>
                        </div>
                        <div class="stat-value">${formatNumber(Math.round(ship2.currentShields))} / ${formatNumber(ship2.stats.totalShields)}</div>
                        <div class="shield-bar">
                            <div class="shield-fill" style="width: ${Math.max(0, Math.min(100, (ship2.currentShields / ship2.stats.totalShields) * 100))}%"></div>
                        </div>
                    </div>
                </div>
                <div class="time-box">
                    <div class="stat-label">Time</div>
                    <div class="stat-value">${battleState.time}s</div>
                </div>
            `;
        }

        function endBattle() {
            if (battleInterval) {
                clearInterval(battleInterval);
                battleInterval = null;
            }
            
            if (!battleState) return;
            
            const ship1 = battleState.ship1;
            const ship2 = battleState.ship2;
            
            ship1.config.battleMode = ship1.originalBattleMode;
            ship2.config.battleMode = ship2.originalBattleMode;
            
            let winner = 'Draw';
            if (ship1.currentHP <= 0 && ship2.currentHP <= 0) {
                winner = 'Double KO';
            } else if (ship1.currentHP <= 0) {
                winner = 'Ship 2 Wins!';
            } else if (ship2.currentHP <= 0) {
                winner = 'Ship 1 Wins!';
            } else if (battleState.time >= 200) {
                winner = 'Time Limit - Draw';
            }
            
            const ship1Log = document.getElementById('ship1-battle-log');
            const ship2Log = document.getElementById('ship2-battle-log');
            const finalEntry1 = document.createElement('div');
            const finalEntry2 = document.createElement('div');
            finalEntry1.className = 'ship-log-entry';
            finalEntry2.className = 'ship-log-entry';
            finalEntry1.style.color = '#00ff00';
            finalEntry2.style.color = '#00ff00';
            finalEntry1.style.fontWeight = 'bold';
            finalEntry2.style.fontWeight = 'bold';
            finalEntry1.textContent = `BATTLE ENDED - ${winner} (${battleState.time}s)`;
            finalEntry2.textContent = `BATTLE ENDED - ${winner} (${battleState.time}s)`;
            ship1Log.appendChild(finalEntry1);
            ship2Log.appendChild(finalEntry2);
            
            ship1Log.scrollTop = ship1Log.scrollHeight;
            ship2Log.scrollTop = ship2Log.scrollHeight;
            
            updateBattleUI();
        }
        function showClearModal(shipNum) {
            const modal = document.getElementById('equipment-modal');
            const modalTitle = document.getElementById('modal-title');
            const modalOptions = document.getElementById('modal-options');
            
            modalTitle.textContent = 'Clear Equipment';
            modalOptions.innerHTML = '';
            
            const clearHangarOption = document.createElement('div');
            clearHangarOption.className = 'modal-option';
            clearHangarOption.textContent = 'Clear Hangar Only (Ship + Drones)';
            clearHangarOption.addEventListener('click', () => {
                clearHangar(shipNum);
                closeModal();
            });
            modalOptions.appendChild(clearHangarOption);
            
            const clearAllOption = document.createElement('div');
            clearAllOption.className = 'modal-option';
            clearAllOption.textContent = 'Clear Everything (Hangar + Resources + Settings)';
            clearAllOption.addEventListener('click', () => {
                clearEverything(shipNum);
                closeModal();
            });
            modalOptions.appendChild(clearAllOption);
            
            modal.style.display = 'flex';
        }
        
        function clearHangar(shipNum) {
            const config = shipConfigurations[shipNum];
            const ship = SHIPS_DATA[config.shipId];
            
            if (!ship) return;
            
            config.lasers = [];
            config.generators = [];
            
            config.drones = Array(8).fill(null).map(() => ({ covers: null, equipment: [null, null] }));
            
            initializeShipSlots(shipNum);
            initializeDroneSlots(shipNum);
            updateStats(shipNum);
        }
        
        function clearEverything(shipNum) {
            clearHangar(shipNum);
            
            shipConfigurations[shipNum].resources = { lasers: null, rockets: null, shields: null, speed: null };
            
            shipConfigurations[shipNum].premium = false;
            document.getElementById(`premium-${shipNum}`).classList.remove('active');
            
            document.getElementById(`rocket-select-${shipNum}`).value = 'none';
            shipConfigurations[shipNum].rocket = 'none';
            
            shipConfigurations[shipNum].battleMode = 'x4';
            document.querySelectorAll(`#ship-panel-${shipNum} .mode-btn`).forEach(btn => {
                btn.classList.remove('active');
                if (btn.dataset.mode === 'x4') {
                    btn.classList.add('active');
                }
            });
            
            const resourceSelects = document.querySelectorAll(`#ship-panel-${shipNum} .resource-select`);
            resourceSelects.forEach(select => {
                select.value = '';
            });
            
            updateStats(shipNum);
        }
        
        function resetBattle() {
            if (battleInterval) {
                clearInterval(battleInterval);
                battleInterval = null;
            }
            
            if (battleState) {
                if (battleState.ship1 && battleState.ship1.originalBattleMode) {
                    shipConfigurations[1].battleMode = battleState.ship1.originalBattleMode;
                }
                if (battleState.ship2 && battleState.ship2.originalBattleMode) {
                    shipConfigurations[2].battleMode = battleState.ship2.originalBattleMode;
                }
                
                [1, 2].forEach(shipNum => {
                    const originalMode = battleState[`ship${shipNum}`].originalBattleMode;
                    if (originalMode) {
                        document.querySelectorAll(`#ship-panel-${shipNum} .mode-btn`).forEach(btn => {
                            btn.classList.remove('active');
                            if (btn.dataset.mode === originalMode) {
                                btn.classList.add('active');
                            }
                        });
                    }
                });
            }
            
            battleState = null;
            
            document.getElementById('ship1-battle-log').innerHTML = '<div class="ship-log-header">Ship 1</div>';
            document.getElementById('ship2-battle-log').innerHTML = '<div class="ship-log-header">Ship 2</div>';
            document.getElementById('ship1-battle-log').classList.add('empty');
            document.getElementById('ship2-battle-log').classList.add('empty');
            document.getElementById('battle-stats').innerHTML = '';
            document.getElementById('battle-history-container').style.display = 'none';
            document.getElementById('history-content-1').innerHTML = '';
            document.getElementById('history-content-2').innerHTML = '';
            initializeBattleUI();
        }

        function initializeBattleUI() {
            const battleStats = document.getElementById('battle-stats');
            battleStats.classList.add('empty');
            battleStats.innerHTML = `
                <div class="ship-status-box">
                    <div class="ship-name-header">Ship 1</div>
                    <div class="hp-shield-combo">
                        <div class="stat-value">0 / 0</div>
                        <div class="hp-bar">
                            <div class="hp-fill" style="width: 0%"></div>
                        </div>
                        <div class="stat-value">0 / 0</div>
                        <div class="shield-bar">
                            <div class="shield-fill" style="width: 0%"></div>
                        </div>
                    </div>
                </div>
                <div class="ship-status-box">
                    <div class="ship-name-header">Ship 2</div>
                    <div class="hp-shield-combo">
                       <div class="stat-value">0 / 0</div>
                        <div class="hp-bar">
                            <div class="hp-fill" style="width: 0%"></div>
                        </div>
                        <div class="stat-value">0 / 0</div>
                        <div class="shield-bar">
                            <div class="shield-fill" style="width: 0%"></div>
                        </div>
                    </div>
                </div>
                <div class="time-box">
                    <div class="stat-label">Time</div>
                    <div class="stat-value">0s</div>
                </div>
            `;

            const ship1Log = document.getElementById('ship1-battle-log');
            const ship2Log = document.getElementById('ship2-battle-log');
            ship1Log.classList.add('empty');
            ship2Log.classList.add('empty');
            ship1Log.innerHTML = '<div class="ship-log-header">Ship 1</div>';
            ship2Log.innerHTML = '<div class="ship-log-header">Ship 2</div>';

        }

        function toggleBattleHistory(shipNum) {
            const arrow1 = document.getElementById('arrow-1');
            const arrow2 = document.getElementById('arrow-2');
            const content1 = document.getElementById('history-content-1');
            const content2 = document.getElementById('history-content-2');
            
            const isCurrentlyExpanded = arrow1.classList.contains('expanded') || arrow2.classList.contains('expanded');
            
            if (isCurrentlyExpanded) {
                arrow1.classList.remove('expanded');
                arrow2.classList.remove('expanded');
                content1.classList.remove('expanded');
                content2.classList.remove('expanded');
            } else {
                arrow1.classList.add('expanded');
                arrow2.classList.add('expanded');
                content1.classList.add('expanded');
                content2.classList.add('expanded');
            }
        }

        function addBattleHistoryEntry(shipNum, time, hpChange, shieldChange, sabRestore, totalDamage) {
            const historyContent = document.getElementById(`history-content-${shipNum}`);
            
            const entry = document.createElement('div');
            entry.className = 'history-entry';
            
            let entryHTML = `<span class="history-tick">T${time}:</span>`;
            
            if (hpChange !== 0) {
                entryHTML += ` <span class="history-hp-change">${hpChange > 0 ? '+' : ''}${formatNumber(Math.round(hpChange))} HP</span>`;
            }
            
            if (shieldChange !== 0) {
                entryHTML += ` <span class="history-shield-change">${shieldChange > 0 ? '+' : ''}${formatNumber(Math.round(shieldChange))} Shield</span>`;
            }
            
            if (sabRestore > 0) {
                entryHTML += ` <span class="history-sab-restore">+${formatNumber(Math.round(sabRestore))} Shield Sab</span>`;
            }
            
            
            entry.innerHTML = entryHTML;
            historyContent.appendChild(entry);
            
            historyContent.scrollTop = historyContent.scrollHeight;
        }

        function clearBattleHistory() {
            document.getElementById('history-content-1').innerHTML = '';
            document.getElementById('history-content-2').innerHTML = '';
            
            document.getElementById('arrow-1').classList.remove('expanded');
            document.getElementById('arrow-2').classList.remove('expanded');
            document.getElementById('history-content-1').classList.remove('expanded');
            document.getElementById('history-content-2').classList.remove('expanded');
        }

        function recordBattleHistory(time, prevShip1HP, prevShip1Shields, prevShip2HP, prevShip2Shields, ship1Damage, ship2Damage) {
            const ship1HPChange = battleState.ship1.currentHP - prevShip1HP;
            const ship1ShieldChange = battleState.ship1.currentShields - prevShip1Shields;
            
            const ship2HPChange = battleState.ship2.currentHP - prevShip2HP;
            const ship2ShieldChange = battleState.ship2.currentShields - prevShip2Shields;
            
            if (ship1HPChange !== 0 || ship1ShieldChange !== 0 || ship1Damage.total > 0) {
                addBattleHistoryEntry(
                    1,
                    time,
                    ship1HPChange,
                    ship1ShieldChange,
                    ship1Damage.sabRestore,
                    ship1Damage.total
                );
            }
            
            if (ship2HPChange !== 0 || ship2ShieldChange !== 0 || ship2Damage.total > 0) {
                addBattleHistoryEntry(
                    2,
                    time,
                    ship2HPChange,
                    ship2ShieldChange,
                    ship2Damage.sabRestore,
                    ship2Damage.total
                );
            }
        }
    </script>
</body>
</html>
 